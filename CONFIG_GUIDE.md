# M-Team 自动下载工具配置指南

## 📖 概述

本文档是 M-Team 自动下载工具的完整配置指南，包含所有配置项的详细说明、使用方法和最佳实践。

## 🚀 快速开始

### 1. 安装依赖
```bash
pnpm install
```

### 2. 配置环境变量
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，填入实际值
# 特别注意标记为"必需"的配置项
```

### 3. 验证配置
```bash
pnpm validate
```

### 4. 启动程序
```bash
# 直接启动（不验证配置）
pnpm start

# 安全启动（先验证配置）
pnpm start:safe
```

## 🔐 必需配置项

以下配置项是程序正常运行所必需的：

| 配置项 | 说明 | 获取方式 |
|--------|------|----------|
| `AUTH_TOKEN` | M-Team 认证令牌 | 浏览器开发者工具 |
| `DID` | 设备 ID | 请求头中获取 |
| `COOKIE` | Cookie 信息 | 浏览器开发者工具 |
| `VISITOR_ID` | 访问者 ID | 请求头中获取 |

### 获取认证信息步骤：

1. **登录 M-Team 网站**
2. **打开浏览器开发者工具** (F12)
3. **切换到 Network 标签页**
4. **刷新页面或进行任何操作**
5. **找到任意请求，查看请求头信息**
6. **复制相应的值到 .env 文件**

## 📋 完整配置项说明

### 🔐 API 基础配置 (8项)

| 环境变量 | 说明 | 默认值 | 是否必需 |
|----------|------|--------|----------|
| `API_BASE_URL` | M-Team API 基础 URL | `https://api.m-team.cc` | 否 |
| `SECRET_KEY` | 签名密钥 | `HLkPcWmycL57mfJt` | 否 |
| `AUTH_TOKEN` | 认证令牌 | - | **是** |
| `DID` | 设备 ID | - | **是** |
| `COOKIE` | Cookie 信息 | - | **是** |
| `VERSION` | 客户端版本号 | `1.1.4` | 否 |
| `WEB_VERSION` | Web 版本号 | `1140` | 否 |
| `VISITOR_ID` | 访问者 ID | - | **是** |

### 📥 下载配置 (9项)

| 环境变量 | 说明 | 默认值 | 建议值 |
|----------|------|--------|--------|
| `DOWNLOAD_DIR` | 种子保存目录 | `torrents` | 自定义目录 |
| `DOWNLOAD_INTERVAL` | 下载间隔 | `30000` | 30000-60000 |
| `DOWNLOAD_GRACEFUL_INTERVAL` | 优雅退出间隔 | `10000` | 10000-30000 |
| `DOWNLOAD_MAX_SIZE` | 最大文件大小 | `157286400` | 根据需求调整 |
| `DOWNLOAD_MIN_SIZE` | 最小文件大小 | `11534336` | 根据需求调整 |
| `DOWNLOAD_RETRY_COUNT` | 重试次数 | `3` | 3-5 |
| `DOWNLOAD_RETRY_DELAY` | 重试延迟 | `5000` | 5000-10000 |
| `DOWNLOAD_TIMEOUT` | 下载超时 | `30000` | 30000-60000 |
| `DOWNLOAD_MAX_CONCURRENT` | 最大并发数 | `1` | 1-3 |

### 🔍 搜索配置 (5项)

| 环境变量 | 说明 | 默认值 | 建议值 |
|----------|------|--------|--------|
| `SEARCH_PAGE_SIZE` | 每页数量 | `100` | 50-100 |
| `SEARCH_START_PAGE` | 起始页码 | `1` | 1 |
| `SEARCH_MAX_ERRORS_PER_PAGE` | 每页最大错误数 | `3` | 3-5 |
| `SEARCH_PAGE_INTERVAL` | 翻页间隔 | `5000` | 5000-10000 |
| `SEARCH_MAX_PAGES_PER_SESSION` | 每次会话最大页数 | `50` | 50-100 |

### 🌐 API 配置 (7项)

| 环境变量 | 说明 | 默认值 | 建议值 |
|----------|------|--------|--------|
| `API_MAX_REQUESTS` | 每分钟最大请求数 | `8` | 5-10 |
| `API_TIME_WINDOW` | 时间窗口 | `60000` | 60000 |
| `API_MAX_RETRIES` | 最大重试次数 | `3` | 3-5 |
| `API_BASE_DELAY` | 基础延迟时间 | `2000` | 2000-5000 |
| `API_MAX_DELAY` | 最大延迟时间 | `10000` | 10000-30000 |
| `API_TIMEOUT` | 请求超时 | `30000` | 30000-60000 |

### 🚀 qBittorrent 配置 (10项)

| 环境变量 | 说明 | 默认值 | 说明 |
|----------|------|--------|------|
| `QB_ENABLED` | 是否启用 | `true` | true/false |
| `QB_BASE_URL` | Web UI 地址 | `http://192.168.50.100:8085` | 自定义地址 |
| `QB_USERNAME` | 用户名 | `admin` | 登录用户名 |
| `QB_PASSWORD` | 密码 | `188642345` | 登录密码 |
| `QB_DOWNLOAD_PATH` | 临时下载路径 | `/downloads/下载中` | 临时目录 |
| `QB_FINAL_PATH` | 最终保存路径 | `/downloads/刷魔力值` | 最终目录 |
| `QB_CATEGORY` | 种子分类 | `刷魔力值` | 分类名称 |
| `QB_TAGS` | 种子标签 | `刷魔力值,待转移` | 逗号分隔 |
| `QB_USE_CATEGORY` | 是否传递分类 | `true` | true/false |
| `QB_TIMEOUT` | 连接超时 | `10000` | 10000-30000 |

### 📝 日志配置 (3项)

| 环境变量 | 说明 | 默认值 | 可选值 |
|----------|------|--------|--------|
| `LOG_SAVE_TO_FILE` | 是否保存到文件 | `false` | true/false |
| `LOG_DIR` | 日志目录 | `logs` | 目录路径 |
| `LOG_LEVEL` | 日志级别 | `info` | debug/info/warn/error |

## ⚙️ 配置调优建议

### 1. **下载频率调优**
- **网络稳定**：可以适当减少 `DOWNLOAD_INTERVAL`
- **网络不稳定**：建议增加 `DOWNLOAD_INTERVAL` 和重试次数
- **服务器限制**：注意观察是否被限制，适当调整频率

### 2. **请求限制调优**
- **避免被限制**：`API_MAX_REQUESTS` 建议不超过 10 次/分钟
- **提高效率**：在允许范围内适当增加请求频率
- **监控响应**：观察 API 响应状态，及时调整

### 3. **超时设置调优**
- **网络快**：可以减少超时时间，提高响应速度
- **网络慢**：适当增加超时时间，避免过早失败
- **服务器慢**：根据服务器响应时间调整

### 4. **日志级别选择**
- **生产环境**：使用 `info` 或 `warn` 级别
- **调试环境**：使用 `debug` 级别获取详细信息
- **问题排查**：临时设置为 `debug` 级别

## 🛡️ 安全注意事项

### 1. **敏感信息保护**
- 不要将 `.env` 文件提交到版本控制系统
- 定期更新认证信息（AUTH_TOKEN、DID、COOKIE、VISITOR_ID）
- 使用强密码保护 qBittorrent

### 2. **访问控制**
- 限制 qBittorrent Web UI 的访问范围
- 定期检查访问日志
- 监控异常访问行为

### 3. **网络安全**
- 使用 HTTPS 连接（如果支持）
- 避免在公共网络中暴露敏感配置
- 定期更新依赖包

## 🔧 故障排除

### 1. **认证错误**
```
🚨 检测到认证错误，程序将立即停止
```
**解决方案**：
- 检查 AUTH_TOKEN 是否过期
- 重新获取 DID 和 VISITOR_ID
- 更新 Cookie 信息

### 2. **网络连接问题**
```
网络连接失败，请检查网络连接
```
**解决方案**：
- 检查网络连接状态
- 验证防火墙设置
- 检查代理配置

### 3. **qBittorrent 连接失败**
```
qBittorrent 连接超时
```
**解决方案**：
- 确认 qBittorrent 正在运行
- 检查 Web UI 是否启用
- 验证用户名和密码
- 检查网络连接

### 4. **请求频率过高**
```
请求频率过高，服务器限制访问
```
**解决方案**：
- 增加 `API_TIME_WINDOW` 值
- 减少 `API_MAX_REQUESTS` 值
- 增加 `DOWNLOAD_INTERVAL` 值

## 📚 相关文档

- [项目 README](README.md) - 项目概述和快速开始
- [代码结构说明](CODE_STRUCTURE.md) - 项目代码结构分析
- [配置改进总结](CONFIG_IMPROVEMENTS.md) - 配置文件改进历史

## 🔄 版本历史

- **v1.1.4** - 完善配置文件注释和文档
- **v1.1.3** - 添加环境变量支持
- **v1.1.2** - 重构配置结构
- **v1.1.1** - 基础配置功能
- **v1.1.0** - 初始版本

## 🤝 获取帮助

如果您遇到配置问题：

1. **查看日志**：检查程序输出的错误信息
2. **验证配置**：使用 `pnpm validate` 检查配置
3. **查阅文档**：参考本文档和相关说明
4. **提交 Issue**：在项目仓库中描述问题
5. **社区讨论**：在相关社区中寻求帮助

---

*最后更新：2024年12月*
